import { MapContainer, TileLayer, Marker, Popup, Polyline, CircleMarker } from 'react-leaflet'
import "leaflet/dist/leaflet.css"
import L from 'leaflet'
import { useState, useEffect, useRef } from 'react';

delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

const signalEmoji = (state) => L.divIcon({
  html: `<div style="font-size: 30px;">${state === "GREEN" ? "ğŸŸ¢" : "ğŸ”´"}</div>`,
  className: 'dummy', iconSize: [30, 30], iconAnchor: [15, 15]
});
const ambulanceEmoji = L.divIcon({
  html: `<div style="font-size: 30px;">ğŸš‘</div>`,
  className: 'dummy', iconSize: [30, 30], iconAnchor: [15, 15]
});
const carIcon = L.divIcon({
  html: `<div style="font-size: 25px;">ğŸš—</div>`,
  className: 'dummy', iconSize: [25, 25], iconAnchor: [12, 12]
});

const POTHOLE_FILL   = '#111111';
const POTHOLE_BORDER = '#000000';
const getSeverityDotColor = (severity) => {
  switch (severity?.toLowerCase()) {
    case 'severe':   return '#d32f2f';
    case 'moderate': return '#ff6f00';
    case 'mild':     return '#f9a825';
    default:         return '#777';
  }
};

function distMeters(lat1, lon1, lat2, lon2) {
  const R    = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a    = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function snapToNearestRoutePoint(lat, lng, allRoutes) {
  let bLat = lat, bLng = lng, bDist = Infinity;
  allRoutes.forEach(({ route }) =>
    route.forEach(([rlat, rlng]) => {
      const d = distMeters(lat, lng, rlat, rlng);
      if (d < bDist) { bDist = d; bLat = rlat; bLng = rlng; }
    })
  );
  return { lat: bLat, lng: bLng };
}

function severityWeight(s) {
  return s?.toLowerCase() === 'severe' ? 3 : s?.toLowerCase() === 'moderate' ? 2 : 1;
}

function computePotholePenalty(route, snappedPotholes, criticality) {
  const SNAP_RADIUS = 25;
  const BASE        = 15;
  const mult        = criticality === 'VERY CRITICAL' ? 2.5 : criticality === 'CRITICAL' ? 1.8 : 1.0;
  let total = 0;
  snappedPotholes.forEach(p => {
    if (route.some(([rlat, rlng]) => distMeters(p.lat, p.lng, rlat, rlng) <= SNAP_RADIUS))
      total += severityWeight(p.severity);
  });
  return Math.round(total * BASE * mult);
}

const DUMMY_POTHOLES = [
  { lat: 9.998127,  lng: 76.299928,  severity: 'severe',   confidence: 0.93 },
  { lat: 9.994999,  lng: 76.292152,  severity: 'moderate', confidence: 0.88 },
  { lat: 10.001680, lng: 76.302950,  severity: 'severe',   confidence: 0.91 },
  { lat: 10.004053, lng: 76.304921,  severity: 'moderate', confidence: 0.85 },
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DONOR ROUTES  â€”  real waypoints between hospitals, keyed "FROM-TO"
// To add more pairs (e.g. H3â†’H1) just add the key and paste the coords.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DONOR_ROUTES = {

  // â”€â”€ H1 â†’ H5  (Lisie Hospital â†’ Renai Medicity) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "H1-H5": [
    [9.988078,76.288166],[9.988826,76.288375],[9.988836,76.288385],
    [9.988841,76.288397],[9.988844,76.288454],[9.988857,76.288509],
    [9.988870,76.288516],[9.988881,76.288513],[9.988893,76.288516],
    [9.988907,76.288507],[9.988925,76.288512],[9.988939,76.288533],
    [9.988975,76.288592],[9.988995,76.288633],[9.989014,76.288632],
    [9.989032,76.288637],[9.989333,76.288536],[9.989760,76.288393],
    [9.990142,76.288229],[9.990567,76.288044],[9.990806,76.287930],
    [9.990900,76.287883],[9.990926,76.287882],[9.990943,76.287892],
    [9.990960,76.287916],[9.991167,76.288159],[9.991345,76.288409],
    [9.991697,76.288828],[9.992013,76.289158],[9.992308,76.289544],
    [9.992637,76.289848],[9.992954,76.290205],[9.993282,76.290505],
    [9.993594,76.290828],[9.993959,76.291144],[9.994255,76.291447],
    [9.994522,76.291710],[9.994999,76.292152],[9.995261,76.292505],
    [9.995488,76.292784],[9.995830,76.293217],[9.996214,76.293760],
    [9.996584,76.294248],[9.996841,76.294657],[9.997184,76.295091],
    [9.997535,76.295483],[9.997899,76.295942],[9.998151,76.296272],
    [9.998461,76.296715],[9.998701,76.296933],[9.999050,76.297395],
    [9.999308,76.297643],[9.999338,76.297684],[9.999388,76.297754],
    [9.999440,76.297826],[9.999494,76.297899],[9.999553,76.297969],
    [9.999604,76.298046],[9.999653,76.298121],[9.999709,76.298195],
    [9.999752,76.298277],[9.999800,76.298350],[9.999987,76.298359],
    [10.000031,76.298424],[10.000239,76.298735],[10.000363,76.298886],
    [10.000476,76.299081],[10.000696,76.299459],[10.000912,76.299868],
    [10.001101,76.300278],[10.001245,76.300765],[10.001301,76.301163],
    [10.001392,76.301607],[10.001455,76.302057],[10.001560,76.302525],
    [10.001680,76.302950],[10.001876,76.303393],[10.002144,76.303738],
    [10.002471,76.304044],[10.002828,76.304327],[10.003217,76.304570],
    [10.003633,76.304765],[10.004053,76.304921],[10.004460,76.305024],
    [10.004897,76.305077],[10.005178,76.305078],[10.005273,76.305062],
    [10.005600,76.304994],[10.005832,76.304922],[10.005996,76.304826],
    [10.006110,76.304788],[10.006433,76.304681],[10.006873,76.304538],
    [10.007297,76.304416],[10.007733,76.304282],[10.007952,76.304219],
    [10.007960,76.304204],[10.007900,76.303992],[10.007786,76.303585],
    [10.007789,76.303560],[10.007808,76.303558],[10.007832,76.303518],
    [10.007858,76.303480],[10.007858,76.303458],[10.007874,76.303414],
  ],

  // â”€â”€ H5 â†’ H1  (Renai Medicity â†’ Lisie Hospital)  [reverse of H1-H5] â”€â”€â”€â”€â”€â”€
  "H5-H1": [
    [10.007874,76.303414],[10.007858,76.303458],[10.007858,76.303480],
    [10.007832,76.303518],[10.007808,76.303558],[10.007789,76.303560],
    [10.007786,76.303585],[10.007900,76.303992],[10.007960,76.304204],
    [10.007952,76.304219],[10.007733,76.304282],[10.007297,76.304416],
    [10.006873,76.304538],[10.006433,76.304681],[10.006110,76.304788],
    [10.005996,76.304826],[10.005832,76.304922],[10.005600,76.304994],
    [10.005273,76.305062],[10.005178,76.305078],[10.004897,76.305077],
    [10.004460,76.305024],[10.004053,76.304921],[10.003633,76.304765],
    [10.003217,76.304570],[10.002828,76.304327],[10.002471,76.304044],
    [10.002144,76.303738],[10.001876,76.303393],[10.001680,76.302950],
    [10.001560,76.302525],[10.001455,76.302057],[10.001392,76.301607],
    [10.001301,76.301163],[10.001245,76.300765],[10.001101,76.300278],
    [10.000912,76.299868],[10.000696,76.299459],[10.000476,76.299081],
    [10.000363,76.298886],[10.000239,76.298735],[10.000031,76.298424],
    [9.999987,76.298359],[9.999800,76.298350],[9.999752,76.298277],
    [9.999709,76.298195],[9.999653,76.298121],[9.999604,76.298046],
    [9.999553,76.297969],[9.999494,76.297899],[9.999440,76.297826],
    [9.999388,76.297754],[9.999338,76.297684],[9.999308,76.297643],
    [9.999050,76.297395],[9.998701,76.296933],[9.998461,76.296715],
    [9.998151,76.296272],[9.997899,76.295942],[9.997535,76.295483],
    [9.997184,76.295091],[9.996841,76.294657],[9.996584,76.294248],
    [9.996214,76.293760],[9.995830,76.293217],[9.995488,76.292784],
    [9.995261,76.292505],[9.994999,76.292152],[9.994522,76.291710],
    [9.994255,76.291447],[9.993959,76.291144],[9.993594,76.290828],
    [9.993282,76.290505],[9.992954,76.290205],[9.992637,76.289848],
    [9.992308,76.289544],[9.992013,76.289158],[9.991697,76.288828],
    [9.991345,76.288409],[9.991167,76.288159],[9.990960,76.287916],
    [9.990943,76.287892],[9.990926,76.287882],[9.990900,76.287883],
    [9.990806,76.287930],[9.990567,76.288044],[9.990142,76.288229],
    [9.989760,76.288393],[9.989333,76.288536],[9.989032,76.288637],
    [9.989014,76.288632],[9.988995,76.288633],[9.988975,76.288592],
    [9.988939,76.288533],[9.988925,76.288512],[9.988907,76.288507],
    [9.988893,76.288516],[9.988881,76.288513],[9.988870,76.288516],
    [9.988857,76.288509],[9.988844,76.288454],[9.988841,76.288397],
    [9.988836,76.288385],[9.988826,76.288375],[9.988078,76.288166],
  ],

  // â”€â”€ H3 â†’ H5  (Aster Medcity â†’ Renai Medicity) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "H3-H5": [
    [9.988078,76.288166],[9.988826,76.288375],[9.988836,76.288385],
    [9.988841,76.288397],[9.988844,76.288454],[9.988857,76.288509],
    [9.988870,76.288516],[9.988881,76.288513],[9.988893,76.288516],
    [9.988907,76.288507],[9.988925,76.288512],[9.988939,76.288533],
    [9.988975,76.288592],[9.988995,76.288633],[9.989014,76.288632],
    [9.989032,76.288637],[9.989333,76.288536],[9.989760,76.288393],
    [9.990142,76.288229],[9.990567,76.288044],[9.990806,76.287930],
    [9.990900,76.287883],[9.990843,76.287778],[9.990505,76.287428],
    [9.990138,76.287158],[9.989808,76.286920],[9.989458,76.286691],
    [9.989130,76.286491],[9.988678,76.286236],[9.988290,76.285981],
    [9.987926,76.285686],[9.987529,76.285359],[9.987529,76.285359],
    [9.986929,76.284685],[9.986638,76.284240],[9.986403,76.283789],
    [9.986222,76.283185],[9.986157,76.282853],[9.985928,76.282288],
    [9.985764,76.281511],[9.985640,76.280920],[9.985581,76.280302],
    [9.985352,76.279817],[9.985175,76.279173],[9.985090,76.278449],
    [9.985162,76.277911],[9.985077,76.277379],[9.984992,76.276921],
    [9.984763,76.276277],[9.984793,76.276200],[9.985131,76.276093],
    [9.985578,76.275929],[9.985961,76.275789],[9.986404,76.275674],
    [9.986847,76.275550],[9.987075,76.275484],[9.987313,76.275535],
    [9.987799,76.275664],[9.988284,76.275798],[9.988731,76.276005],
    [9.989140,76.276110],[9.989510,76.276273],[9.989861,76.276328],
    [9.990338,76.276462],[9.990599,76.276547],[9.991029,76.276698],
    [9.991465,76.276854],[9.991927,76.277002],[9.992312,76.277110],
    [9.992759,76.277235],[9.993175,76.277364],[9.993590,76.277435],
    [9.993629,76.277423],[9.993654,76.277399],[9.993785,76.277229],
    [9.993857,76.277221],[9.993973,76.277245],[9.994419,76.277406],
    [9.994849,76.277517],[9.995274,76.277631],[9.995703,76.277751],
    [9.996163,76.277949],[9.996163,76.277949],[9.996988,76.278173],
    [9.997423,76.278315],[9.997824,76.278397],[9.998405,76.278533],
    [9.998846,76.278716],[9.999296,76.278847],[9.999761,76.278955],
    [10.000191,76.279120],[10.000633,76.279218],[10.000994,76.279321],
    [10.001322,76.279389],[10.001338,76.279359],[10.001300,76.279171],
    [10.001191,76.278711],[10.001063,76.278249],[10.000984,76.277993],
    [10.001006,76.277979],[10.001144,76.277947],[10.001612,76.277843],
    [10.002012,76.277731],[10.002463,76.277627],[10.002917,76.277539],
    [10.003352,76.277412],[10.003809,76.277280],[10.004189,76.277041],
    [10.004346,76.276991],[10.004454,76.276947],[10.004612,76.276866],
    [10.005080,76.276736],[10.005331,76.276664],[10.005664,76.276563],
    [10.005687,76.276581],[10.005846,76.277028],[10.005975,76.277394],
    [10.006062,76.277609],[10.006291,76.278146],[10.006487,76.278222],
    [10.006650,76.278186],[10.006674,76.278093],[10.0066809,76.2774219],
  ],

  // â”€â”€ H5 â†’ H3  (Renai Medicity â†’ Aster Medcity)  [reverse of H3-H5] â”€â”€â”€â”€â”€â”€â”€
  "H5-H3": [
    [10.0066809,76.2774219],[10.006674,76.278093],[10.006650,76.278186],
    [10.006487,76.278222],[10.006291,76.278146],[10.006062,76.277609],
    [10.005975,76.277394],[10.005846,76.277028],[10.005687,76.276581],
    [10.005664,76.276563],[10.005331,76.276664],[10.005080,76.276736],
    [10.004612,76.276866],[10.004454,76.276947],[10.004346,76.276991],
    [10.004189,76.277041],[10.003809,76.277280],[10.003352,76.277412],
    [10.002917,76.277539],[10.002463,76.277627],[10.002012,76.277731],
    [10.001612,76.277843],[10.001144,76.277947],[10.001006,76.277979],
    [10.000984,76.277993],[10.001063,76.278249],[10.001191,76.278711],
    [10.001300,76.279171],[10.001338,76.279359],[10.001322,76.279389],
    [10.000994,76.279321],[10.000633,76.279218],[10.000191,76.279120],
    [9.999761,76.278955],[9.999296,76.278847],[9.998846,76.278716],
    [9.998405,76.278533],[9.997824,76.278397],[9.997423,76.278315],
    [9.996988,76.278173],[9.996163,76.277949],[9.995703,76.277751],
    [9.995274,76.277631],[9.994849,76.277517],[9.994419,76.277406],
    [9.993973,76.277245],[9.993857,76.277221],[9.993785,76.277229],
    [9.993654,76.277399],[9.993629,76.277423],[9.993590,76.277435],
    [9.993175,76.277364],[9.992759,76.277235],[9.992312,76.277110],
    [9.991927,76.277002],[9.991465,76.276854],[9.991029,76.276698],
    [9.990599,76.276547],[9.990338,76.276462],[9.989861,76.276328],
    [9.989510,76.276273],[9.989140,76.276110],[9.988731,76.276005],
    [9.988284,76.275798],[9.987799,76.275664],[9.987313,76.275535],
    [9.987075,76.275484],[9.986847,76.275550],[9.986404,76.275674],
    [9.985961,76.275789],[9.985578,76.275929],[9.985131,76.276093],
    [9.984793,76.276200],[9.984763,76.276277],[9.984992,76.276921],
    [9.985077,76.277379],[9.985162,76.277911],[9.985090,76.278449],
    [9.985175,76.279173],[9.985352,76.279817],[9.985581,76.280302],
    [9.985640,76.280920],[9.985764,76.281511],[9.985928,76.282288],
    [9.986157,76.282853],[9.986222,76.283185],[9.986403,76.283789],
    [9.986638,76.284240],[9.986929,76.284685],[9.987529,76.285359],
    [9.987926,76.285686],[9.988290,76.285981],[9.988678,76.286236],
    [9.989130,76.286491],[9.989458,76.286691],[9.989808,76.286920],
    [9.990138,76.287158],[9.990505,76.287428],[9.990843,76.287778],
    [9.990900,76.287883],[9.990806,76.287930],[9.990567,76.288044],
    [9.990142,76.288229],[9.989760,76.288393],[9.989333,76.288536],
    [9.989032,76.288637],[9.989014,76.288632],[9.988995,76.288633],
    [9.988975,76.288592],[9.988939,76.288533],[9.988925,76.288512],
    [9.988907,76.288507],[9.988893,76.288516],[9.988881,76.288513],
    [9.988870,76.288516],[9.988857,76.288509],[9.988844,76.288454],
    [9.988841,76.288397],[9.988836,76.288385],[9.988826,76.288375],
    [9.988078,76.288166],
  ],

  // â”€â”€ H1 â†’ H3 / H3 â†’ H1  (Lisie â†” Aster Medcity) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Paste your real waypoints here when you have them.
  // For now we derive them from the existing accident route reversed.
  // Replace these arrays with real coords at any time â€” nothing else needs changing.
  "H1-H3": null,   // will fall through to console.error below
  "H3-H1": null,
};

// Hospital display names
const HOSPITAL_NAMES = {
  H1: "Lisie Hospital",
  H3: "Aster Medcity",
  H5: "Renai Medicity",
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MapView
//   donorMode  â€“ switches to hospitalâ†’hospital organ transport mode
//   donorFrom  â€“ origin hospital ID  e.g. "H1"
//   donorTo    â€“ destination hospital ID  e.g. "H5"
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MapView({ donorMode = false, donorFrom = null, donorTo = null }) {
  const SERVER = "http://localhost:5001";
  const center = [9.9930419, 76.3017048];

  const [selectedHospital, setSelectedHospital] = useState(null);
  const [initialETA,       setInitialETA]       = useState(null);
  const [startTime,        setStartTime]         = useState(null);
  const [etaLogged,        setEtaLogged]         = useState(false);
  const [etaBias,          setEtaBias]           = useState({ morning: 0, afternoon: 0, night: 0 });
  const [arrived,          setArrived]           = useState(false);
  const [route,            setRoute]             = useState([]);
  const [segmentIndex,     setsegmentIndex]      = useState(0);
  const [progress,         setProgress]          = useState(0);
  const [currentPosition,  setCurrentPosition]   = useState(center);
  const [criticality,      setCriticality]       = useState("CRITICAL");
  const [hospitalETAs,     setHospitalETAs]      = useState([]);
  const [isMaster,         setIsMaster]          = useState(true);
  const [potholes,         setPotholes]          = useState([]);
  const [snappedPotholes,  setSnappedPotholes]   = useState([]);
  const [useDummyPotholes, setUseDummyPotholes]  = useState(false);

  const [signals, setSignals] = useState([
    { id: 1, position: [9.9954740, 76.3014861], state: "RED" },
    { id: 2, position: [9.992308,  76.289544],  state: "RED" },
    { id: 3, position: [9.9954740, 76.3014861], state: "RED" },
    { id: 4, position: [9.994999,  76.292152],  state: "RED" },
    { id: 5, position: [9.985764,  76.281511],  state: "RED" },
  ]);

  const [cars, setCars] = useState([
    { id: 1, position: [9.995211, 76.301557], movedAside: false },
    { id: 2, position: [9.995467, 76.292663], movedAside: false },
    { id: 3, position: [9.992654, 76.289889], movedAside: false },
    { id: 4, position: [9.985862, 76.281859], movedAside: false },
  ]);

  const audioContextRef = useRef(null);
  const beepIntervalRef = useRef(null);
  const syncIntervalRef = useRef(null);
  const [deviceId] = useState(() => `device_${Math.random().toString(36).substr(2, 9)}`);

  // â”€â”€ Accident-mode routes (depot â†’ hospital) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const routeLisie = [
    [9.9908649,76.3021516],[9.9911956,76.3021332],[9.9916629,76.3020623],
    [9.9922232,76.3019409],[9.9923517,76.3019267],[9.9930340,76.3018243],
    [9.9933433,76.3017846],[9.9944848,76.3016587],[9.9954740,76.3014861],
    [9.9960327,76.3013843],[9.995949,76.301045],[9.995984,76.300702],
    [9.996049,76.300507],[9.996170,76.300286],[9.996393,76.300069],
    [9.996601,76.299934],[9.996774,76.299817],[9.996932,76.299788],
    [9.997055,76.299734],[9.997190,76.299701],[9.997459,76.299668],
    [9.997637,76.299723],[9.997809,76.299777],[9.997974,76.299850],
    [9.998127,76.299928],[9.998211,76.300093],[9.998417,76.300106],
    [9.998593,76.300155],[9.998847,76.300200],[9.999005,76.300155],
    [9.999190,76.300075],[9.999422,76.300012],[9.999607,76.299932],
    [9.999767,76.299871],[10.000012,76.299828],[10.000273,76.299730],
    [10.000505,76.299541],[10.000501,76.299491],[10.000501,76.299449],
    [10.000494,76.299395],[10.000481,76.299358],[10.000428,76.299286],
    [10.000388,76.299206],[10.000339,76.299124],[10.000291,76.299052],
    [10.000237,76.298974],[10.000187,76.298901],[10.000127,76.298830],
    [10.000082,76.298750],[10.000044,76.298720],[9.999999,76.298640],
    [9.999942,76.298569],[9.999890,76.298492],[9.999840,76.298418],
    [9.999800,76.298350],[9.999752,76.298277],[9.999709,76.298195],
    [9.999653,76.298121],[9.999604,76.298046],[9.999553,76.297969],
    [9.999494,76.297899],[9.999440,76.297826],[9.999388,76.297754],
    [9.999338,76.297684],[9.999308,76.297643],[9.999050,76.297395],
    [9.998701,76.296933],[9.998461,76.296715],[9.998151,76.296272],
    [9.997899,76.295942],[9.997535,76.295483],[9.997184,76.295091],
    [9.996841,76.294657],[9.996584,76.294248],[9.996214,76.293760],
    [9.995830,76.293217],[9.995488,76.292784],[9.995261,76.292505],
    [9.994999,76.292152],[9.994522,76.291710],[9.994255,76.291447],
    [9.993959,76.291144],[9.993594,76.290828],[9.993282,76.290505],
    [9.992954,76.290205],[9.992637,76.289848],[9.992308,76.289544],
    [9.992013,76.289158],[9.991697,76.288828],[9.991345,76.288409],
    [9.991167,76.288159],[9.990960,76.287916],[9.990943,76.287892],
    [9.990926,76.287882],[9.990900,76.287883],[9.990806,76.287930],
    [9.990567,76.288044],[9.990142,76.288229],[9.989760,76.288393],
    [9.989333,76.288536],[9.989032,76.288637],[9.989014,76.288632],
    [9.988995,76.288633],[9.988975,76.288592],[9.988939,76.288533],
    [9.988925,76.288512],[9.988907,76.288507],[9.988893,76.288516],
    [9.988881,76.288513],[9.988870,76.288516],[9.988857,76.288509],
    [9.988844,76.288454],[9.988841,76.288397],[9.988836,76.288385],
    [9.988826,76.288375],[9.988078,76.288166],
  ];

  const routeAsterMedcity = [
    [9.9908649,76.3021516],[9.9911956,76.3021332],[9.9916629,76.3020623],
    [9.9922232,76.3019409],[9.9923517,76.3019267],[9.9930340,76.3018243],
    [9.9933433,76.3017846],[9.9944848,76.3016587],[9.9954740,76.3014861],
    [9.9960327,76.3013843],[9.995963,76.301266],[9.995954,76.301249],
    [9.995961,76.301227],[9.995958,76.301195],[9.995948,76.301154],
    [9.995940,76.301109],[9.995929,76.301016],[9.995930,76.300971],
    [9.995936,76.300918],[9.995930,76.300875],[9.995936,76.300845],
    [9.995949,76.300790],[9.995962,76.300726],[9.995982,76.300656],
    [9.996002,76.300610],[9.996013,76.300565],[9.996028,76.300528],
    [9.996051,76.300481],[9.996117,76.300335],[9.996162,76.300264],
    [9.996207,76.300202],[9.996271,76.300136],[9.996338,76.300073],
    [9.996416,76.300022],[9.996491,76.299975],[9.996567,76.299922],
    [9.996648,76.299893],[9.996732,76.299852],[9.996811,76.299814],
    [9.996901,76.299786],[9.996985,76.299753],[9.997069,76.299727],
    [9.997154,76.299698],[9.997244,76.299682],[9.997333,76.299668],
    [9.997428,76.299667],[9.997514,76.299677],[9.997559,76.299682],
    [9.997601,76.299693],[9.997648,76.299703],[9.997689,76.299712],
    [9.997734,76.299731],[9.997778,76.299739],[9.997821,76.299757],
    [9.997860,76.299770],[9.997898,76.299801],[9.997941,76.299819],
    [9.997986,76.299846],[9.998019,76.299863],[9.998054,76.299888],
    [9.998084,76.299917],[9.998124,76.299949],[9.998159,76.299972],
    [9.998188,76.300013],[9.998217,76.300046],[9.998249,76.300074],
    [9.998271,76.300115],[9.998298,76.300122],[9.998363,76.300124],
    [9.998411,76.300135],[9.998498,76.300153],[9.998591,76.300169],
    [9.998676,76.300183],[9.998769,76.300196],[9.998845,76.300217],
    [9.998900,76.300218],[9.998927,76.300211],[9.998946,76.300210],
    [9.999035,76.300181],[9.999120,76.300149],[9.999202,76.300124],
    [9.999298,76.300092],[9.999370,76.300072],[9.999464,76.300034],
    [9.999667,76.299967],[9.999719,76.299944],[9.999796,76.299918],
    [9.999886,76.299890],[9.999970,76.299856],[10.000049,76.299828],
    [10.000143,76.299803],[10.000237,76.299781],[10.000318,76.299737],
    [10.000388,76.299685],[10.000474,76.299617],[10.000463,76.299557],
    [10.000483,76.299525],[10.000502,76.299479],[10.000481,76.299412],
    [10.000484,76.299384],[10.000425,76.299296],[10.000201,76.298929],
    [9.999930,76.298575],[9.999858,76.298414],[9.999899,76.298385],
    [9.999959,76.298363],[9.999987,76.298359],[10.000031,76.298424],
    [10.000239,76.298735],[10.000363,76.298886],[10.000476,76.299081],
    [10.000696,76.299459],[10.000912,76.299868],[10.001101,76.300278],
    [10.001245,76.300765],[10.001301,76.301163],[10.001392,76.301607],
    [10.001455,76.302057],[10.001560,76.302525],[10.001680,76.302950],
    [10.001876,76.303393],[10.002144,76.303738],[10.002471,76.304044],
    [10.002828,76.304327],[10.003217,76.304570],[10.003633,76.304765],
    [10.004053,76.304921],[10.004460,76.305024],[10.004897,76.305077],
    [10.005178,76.305078],[10.005273,76.305062],[10.005600,76.304994],
    [10.005832,76.304922],[10.005996,76.304826],[10.006110,76.304788],
    [10.006433,76.304681],[10.006873,76.304538],[10.007297,76.304416],
    [10.007733,76.304282],[10.007952,76.304219],[10.007960,76.304204],
    [10.007900,76.303992],[10.007786,76.303585],[10.007789,76.303560],
    [10.007808,76.303558],[10.007832,76.303518],[10.007858,76.303480],
    [10.007858,76.303458],[10.007874,76.303414],
  ];

  const routeRennai = [
    [9.9908649,76.3021516],[9.9911956,76.3021332],[9.9916629,76.3020623],
    [9.9922232,76.3019409],[9.9923517,76.3019267],[9.9930340,76.3018243],
    [9.9933433,76.3017846],[9.9944848,76.3016587],[9.9954740,76.3014861],
    [9.9960327,76.3013843],[9.995963,76.301266],[9.995954,76.301249],
    [9.995961,76.301227],[9.995958,76.301195],[9.995948,76.301154],
    [9.995940,76.301109],[9.995929,76.301016],[9.995930,76.300971],
    [9.995936,76.300918],[9.995930,76.300875],[9.995936,76.300845],
    [9.995949,76.300790],[9.995962,76.300726],[9.995982,76.300656],
    [9.996002,76.300610],[9.996013,76.300565],[9.996028,76.300528],
    [9.996051,76.300481],[9.996117,76.300335],[9.996162,76.300264],
    [9.996207,76.300202],[9.996271,76.300136],[9.996338,76.300073],
    [9.996416,76.300022],[9.996491,76.299975],[9.996567,76.299922],
    [9.996648,76.299893],[9.996732,76.299852],[9.996811,76.299814],
    [9.996901,76.299786],[9.996985,76.299753],[9.997069,76.299727],
    [9.997154,76.299698],[9.997244,76.299682],[9.997333,76.299668],
    [9.997428,76.299667],[9.997514,76.299677],[9.997559,76.299682],
    [9.997601,76.299693],[9.997648,76.299703],[9.997689,76.299712],
    [9.997734,76.299731],[9.997778,76.299739],[9.997821,76.299757],
    [9.997860,76.299770],[9.997898,76.299801],[9.997941,76.299819],
    [9.997986,76.299846],[9.998019,76.299863],[9.998054,76.299888],
    [9.998084,76.299917],[9.998124,76.299949],[9.998159,76.299972],
    [9.998188,76.300013],[9.998217,76.300046],[9.998249,76.300074],
    [9.998271,76.300115],[9.998298,76.300122],[9.998363,76.300124],
    [9.998411,76.300135],[9.998498,76.300153],[9.998591,76.300169],
    [9.998676,76.300183],[9.998769,76.300196],[9.998845,76.300217],
    [9.998900,76.300218],[9.998927,76.300211],[9.998946,76.300210],
    [9.999035,76.300181],[9.999120,76.300149],[9.999202,76.300124],
    [9.999298,76.300092],[9.999370,76.300072],[9.999464,76.300034],
    [9.999667,76.299967],[9.999719,76.299944],[9.999796,76.299918],
    [9.999886,76.299890],[9.999970,76.299856],[10.000049,76.299828],
    [10.000143,76.299803],[10.000237,76.299781],[10.000318,76.299737],
    [10.000388,76.299685],[10.000474,76.299617],[10.000463,76.299557],
    [10.000483,76.299525],[10.000502,76.299479],[10.000481,76.299412],
    [10.000484,76.299384],[10.000425,76.299296],[9.999999,76.298640],
    [9.999942,76.298569],[9.999890,76.298492],[9.999840,76.298418],
    [9.999800,76.298350],[9.999752,76.298277],[9.999709,76.298195],
    [9.999653,76.298121],[9.999604,76.298046],[9.999553,76.297969],
    [9.999494,76.297899],[9.999440,76.297826],[9.999388,76.297754],
    [9.999338,76.297684],[9.999308,76.297643],[9.999050,76.297395],
    [9.998701,76.296933],[9.998461,76.296715],[9.998151,76.296272],
    [9.997899,76.295942],[9.997535,76.295483],[9.997184,76.295091],
    [9.996841,76.294657],[9.996584,76.294248],[9.996214,76.293760],
    [9.995830,76.293217],[9.995488,76.292784],[9.995261,76.292505],
    [9.994999,76.292152],[9.994522,76.291710],[9.994255,76.291447],
    [9.993959,76.291144],[9.993594,76.290828],[9.993282,76.290505],
    [9.992954,76.290205],[9.992637,76.289848],[9.992308,76.289544],
    [9.991996,76.289173],[9.991709,76.288791],[9.991365,76.288431],
    [9.991089,76.288091],[9.990843,76.287778],[9.990505,76.287428],
    [9.990138,76.287158],[9.989808,76.286920],[9.989458,76.286691],
    [9.989130,76.286491],[9.988678,76.286236],[9.988290,76.285981],
    [9.987926,76.285686],[9.987529,76.285359],[9.986929,76.284685],
    [9.986638,76.284240],[9.986403,76.283789],[9.986222,76.283185],
    [9.986157,76.282853],[9.985928,76.282288],[9.985764,76.281511],
    [9.985640,76.280920],[9.985581,76.280302],[9.985352,76.279817],
    [9.985175,76.279173],[9.985090,76.278449],[9.985162,76.277911],
    [9.985077,76.277379],[9.984992,76.276921],[9.984763,76.276277],
    [9.984793,76.276200],[9.985131,76.276093],[9.985578,76.275929],
    [9.985961,76.275789],[9.986404,76.275674],[9.986847,76.275550],
    [9.987075,76.275484],[9.987313,76.275535],[9.987799,76.275664],
    [9.988284,76.275798],[9.988731,76.276005],[9.989140,76.276110],
    [9.989510,76.276273],[9.989861,76.276328],[9.990338,76.276462],
    [9.990599,76.276547],[9.991029,76.276698],[9.991465,76.276854],
    [9.991927,76.277002],[9.992312,76.277110],[9.992759,76.277235],
    [9.993175,76.277364],[9.993590,76.277435],[9.993629,76.277423],
    [9.993654,76.277399],[9.993785,76.277229],[9.993857,76.277221],
    [9.993973,76.277245],[9.994419,76.277406],[9.994849,76.277517],
    [9.995274,76.277631],[9.995703,76.277751],[9.996163,76.277949],
    [9.996988,76.278173],[9.997423,76.278315],[9.997824,76.278397],
    [9.998405,76.278533],[9.998846,76.278716],[9.999296,76.278847],
    [9.999761,76.278955],[10.000191,76.279120],[10.000633,76.279218],
    [10.000994,76.279321],[10.001322,76.279389],[10.001338,76.279359],
    [10.001300,76.279171],[10.001191,76.278711],[10.001063,76.278249],
    [10.000984,76.277993],[10.001006,76.277979],[10.001144,76.277947],
    [10.001612,76.277843],[10.002012,76.277731],[10.002463,76.277627],
    [10.002917,76.277539],[10.003352,76.277412],[10.003809,76.277280],
    [10.004189,76.277041],[10.004346,76.276991],[10.004454,76.276947],
    [10.004612,76.276866],[10.005080,76.276736],[10.005331,76.276664],
    [10.005664,76.276563],[10.005687,76.276581],[10.005846,76.277028],
    [10.005975,76.277394],[10.006062,76.277609],[10.006291,76.278146],
    [10.006487,76.278222],[10.006650,76.278186],[10.006674,76.278093],
    [10.0066809,76.2774219],
  ];

  const hospitalRoutes = [
    { id: "H1", name: "Lisie Hospital", route: routeLisie },
    { id: "H3", name: "Aster Medcity",  route: routeAsterMedcity },
    { id: "H5", name: "Renai Medicity", route: routeRennai },
  ];

  // â”€â”€ Sync helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const saveSyncState = async (data) => {
    try {
      await fetch(`${SERVER}/sync`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
    } catch (e) {}
  };
  const getSyncState = async () => {
    try { const res = await fetch(`${SERVER}/sync`); return await res.json(); }
    catch (e) { return null; }
  };

  // â”€â”€ Pothole fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (useDummyPotholes) { setPotholes(DUMMY_POTHOLES); setSnappedPotholes(DUMMY_POTHOLES); return; }
    const fetchPotholes = async () => {
      try {
        const res  = await fetch(`${SERVER}/potholes`);
        const data = await res.json();
        setPotholes(data);
        setSnappedPotholes(data.map(p => {
          const { lat, lng } = snapToNearestRoutePoint(parseFloat(p.lat), parseFloat(p.lng), hospitalRoutes);
          return { ...p, lat, lng };
        }));
      } catch (err) { console.error("Failed to fetch potholes", err); }
    };
    fetchPotholes();
    const iv = setInterval(fetchPotholes, 5000);
    return () => clearInterval(iv);
  }, [useDummyPotholes]);

  // â”€â”€ DONOR MODE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Simply looks up the real pre-mapped route by key and sets state.
  // Every other effect (animation, signals, potholes, sync) reuses unchanged.
  useEffect(() => {
    if (!donorMode || !donorFrom || !donorTo || donorFrom === donorTo) return;

    const key        = `${donorFrom}-${donorTo}`;
    const donorRoute = DONOR_ROUTES[key];

    if (!donorRoute) {
      console.error(`No donor route defined for ${key}. Add it to DONOR_ROUTES at the top of MapView.jsx.`);
      return;
    }

    setCriticality("VERY CRITICAL");   // organ transport = always highest priority

    setRoute(donorRoute);
    setsegmentIndex(0);
    setProgress(0);
    setCurrentPosition(donorRoute[0]); // ambulance starts AT the from-hospital
    setArrived(false);
    setEtaLogged(false);
    setStartTime(Date.now());
    setSelectedHospital({ id: donorTo, name: HOSPITAL_NAMES[donorTo] });

    let totalDist = 0;
    for (let i = 0; i < donorRoute.length - 1; i++)
      totalDist += distMeters(donorRoute[i][0], donorRoute[i][1], donorRoute[i+1][0], donorRoute[i+1][1]);
    const etaSecs = Math.round(totalDist / 20);
    setInitialETA(etaSecs);
    setHospitalETAs([{
      id:      donorTo,
      name:    HOSPITAL_NAMES[donorTo],
      eta:     etaSecs,
      penalty: computePotholePenalty(donorRoute, snappedPotholes, "VERY CRITICAL"),
    }]);
  }, [donorMode, donorFrom, donorTo]); // eslint-disable-line react-hooks/exhaustive-deps

  // â”€â”€ Master broadcast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (!isMaster || !route.length) return;
    const broadcast = async () => {
      const thr = getThresholdDistance();
      const nearbySignals  = signals.map(s => ({ id: s.id, d: distMeters(currentPosition[0], currentPosition[1], s.position[0], s.position[1]) })).filter(s => s.d < thr && s.d > 10).map(s => s.id);
      const shouldBeep     = nearbySignals.length > 0;
      const nearbyPotholes = snappedPotholes.some(p => distMeters(currentPosition[0], currentPosition[1], p.lat, p.lng) < 50);
      await saveSyncState({ position: currentPosition, nearbySignals, nearbyPotholes, shouldBeep, criticality, timestamp: Date.now(), masterId: deviceId, route, segmentIndex, arrived });
    };
    broadcast();
    const iv = setInterval(broadcast, 200);
    return () => clearInterval(iv);
  }, [isMaster, currentPosition, criticality, signals, route, segmentIndex, arrived, deviceId, snappedPotholes]);

  // â”€â”€ Follower sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (isMaster) return;
    const check = async () => {
      try {
        const d = await getSyncState();
        if (!d || d.masterId === deviceId || Date.now() - d.timestamp > 2000) return;
        if (d.position)              setCurrentPosition(d.position);
        if (d.route?.length)         { setRoute(d.route); setsegmentIndex(d.segmentIndex || 0); }
        if (d.criticality)           setCriticality(d.criticality);
        if (d.arrived !== undefined) setArrived(d.arrived);
        if (d.position) {
          const thr = { STABLE: 40, CRITICAL: 80, "VERY CRITICAL": 200 }[d.criticality] ?? 60;
          setSignals(prev => prev.map(s => ({ ...s, state: distMeters(d.position[0], d.position[1], s.position[0], s.position[1]) <= thr ? "GREEN" : "RED" })));
        }
        if (d.shouldBeep) { if (!beepIntervalRef.current) { triggerBeep(); beepIntervalRef.current = setInterval(triggerBeep, 500); } }
        else               { if (beepIntervalRef.current)  { clearInterval(beepIntervalRef.current); beepIntervalRef.current = null; } }
      } catch (e) { console.error("Sync error:", e); }
    };
    check();
    syncIntervalRef.current = setInterval(check, 200);
    return () => { clearInterval(syncIntervalRef.current); if (beepIntervalRef.current) { clearInterval(beepIntervalRef.current); beepIntervalRef.current = null; } };
  }, [isMaster, deviceId]);

  const ARRIVAL_THRESHOLD_METERS = 15;
  const hasArrived = () => {
    if (!route.length) return false;
    const [endLat, endLng] = route[route.length - 1];
    return distMeters(currentPosition[0], currentPosition[1], endLat, endLng) <= ARRIVAL_THRESHOLD_METERS;
  };

  useEffect(() => { if (!route.length || arrived) return; if (hasArrived()) setArrived(true); }, [currentPosition, route, arrived]);
  useEffect(() => {
    if (!arrived || etaLogged || !startTime || initialETA === null) return;
    const actual = Math.round((Date.now() - startTime) / 1000);
    const bucket = getTimeBucket();
    setEtaBias(prev => ({ ...prev, [bucket]: prev[bucket] + 0.2 * (actual - initialETA) }));
    setEtaLogged(true);
  }, [arrived]);

  const getThresholdDistance = () => ({ STABLE: 40, CRITICAL: 80, "VERY CRITICAL": 200 }[criticality] ?? 60);

  // â”€â”€ Movement animation (unchanged â€” same for both modes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    if (!route || route.length < 2 || !isMaster) return;
    const iv = setInterval(() => {
      if (hasArrived()) { clearInterval(iv); return; }
      if (segmentIndex >= route.length - 1) return;
      const [lat1, lng1] = route[segmentIndex];
      const [lat2, lng2] = route[segmentIndex + 1];
      const np = progress + 0.15;
      let lat, lng;
      if (np >= 1) { setsegmentIndex(segmentIndex + 1); setProgress(0); [lat, lng] = route[segmentIndex + 1]; }
      else         { lat = lat1 + (lat2 - lat1) * np; lng = lng1 + (lng2 - lng1) * np; setProgress(np); }
      setCurrentPosition([lat, lng]);
      setSignals(prev => prev.map(s => ({ ...s, state: distMeters(lat, lng, s.position[0], s.position[1]) <= getThresholdDistance() ? "GREEN" : "RED" })));
      setCars(prev => prev.map(c => distMeters(lat, lng, c.position[0], c.position[1]) < 80 && !c.movedAside ? { ...c, position: [c.position[0] - 0.00008, c.position[1] + 0.00008], movedAside: true } : c));
      const sb = signals.some(s => { const d = distMeters(lat, lng, s.position[0], s.position[1]); return d < getThresholdDistance() && d > 10; });
      if (sb && !beepIntervalRef.current)  { triggerBeep(); beepIntervalRef.current = setInterval(triggerBeep, 500); }
      if (!sb && beepIntervalRef.current)  { clearInterval(beepIntervalRef.current); beepIntervalRef.current = null; }
    }, 100);
    return () => { clearInterval(iv); if (beepIntervalRef.current) { clearInterval(beepIntervalRef.current); beepIntervalRef.current = null; } };
  }, [segmentIndex, progress, criticality, route, isMaster]);

  // â”€â”€ ETA helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const AMBULANCE_SPEED = 20;
  const getTimeBucket   = () => { const h = new Date().getHours(); return h < 10 ? "morning" : h < 18 ? "afternoon" : "night"; };
  const geDelayTime     = () => ({ STABLE: 10, CRITICAL: 5, "VERY CRITICAL": 2 }[criticality] ?? 8);
  const getDistance     = () => {
    let d = 0;
    if (segmentIndex < route.length - 1) d += distMeters(currentPosition[0], currentPosition[1], route[segmentIndex + 1][0], route[segmentIndex + 1][1]);
    for (let i = segmentIndex + 1; i < route.length - 1; i++) d += distMeters(route[i][0], route[i][1], route[i + 1][0], route[i + 1][1]);
    return d;
  };
  const ETAseconds = () => Math.max(0, Math.round(getDistance() / AMBULANCE_SPEED + signals.filter(s => distMeters(currentPosition[0], currentPosition[1], s.position[0], s.position[1]) <= getDistance() && s.state === "RED").length * geDelayTime() + etaBias[getTimeBucket()]));
  const computeETAForRoute = (testRoute, bias = etaBias) => {
    if (!testRoute || testRoute.length < 2) return Infinity;
    let dist = 0;
    for (let i = 0; i < testRoute.length - 1; i++) dist += distMeters(testRoute[i][0], testRoute[i][1], testRoute[i + 1][0], testRoute[i + 1][1]);
    return Math.round(dist / AMBULANCE_SPEED + signals.filter(s => s.state === "RED").length * geDelayTime() + computePotholePenalty(testRoute, snappedPotholes, criticality) + bias[getTimeBucket()]);
  };
  const formETA = (s) => `${Math.floor(s / 60)} mins ${s % 60} secs`;

  // â”€â”€ Accident-only: auto select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const autoSelectNearestHospital = () => {
    if (beepIntervalRef.current) { clearInterval(beepIntervalRef.current); beepIntervalRef.current = null; }
    setCars([
      { id: 1, position: [9.995211, 76.301557], movedAside: false },
      { id: 2, position: [9.995467, 76.292663], movedAside: false },
      { id: 3, position: [9.992654, 76.289889], movedAside: false },
      { id: 4, position: [9.985862, 76.281859], movedAside: false },
    ]);
    const etaList = hospitalRoutes.map(h => ({ id: h.id, name: h.name, eta: computeETAForRoute(h.route, etaBias), penalty: computePotholePenalty(h.route, snappedPotholes, criticality) }));
    setHospitalETAs(etaList);
    const best = etaList.reduce((a, b) => a.eta < b.eta ? a : b);
    const nh   = hospitalRoutes.find(h => h.id === best.id);
    if (!nh) { alert("No valid routes."); return; }
    setSelectedHospital(nh);
    setRoute(nh.route);
    setsegmentIndex(0); setProgress(0);
    setCurrentPosition(nh.route[0]);
    let td = 0;
    for (let i = 0; i < nh.route.length - 1; i++) td += distMeters(nh.route[i][0], nh.route[i][1], nh.route[i + 1][0], nh.route[i + 1][1]);
    setInitialETA(Math.round(td / AMBULANCE_SPEED));
    setStartTime(Date.now());
    setArrived(false); setEtaLogged(false);
  };

  const resetLearning = () => { setEtaBias({ morning: 0, afternoon: 0, night: 0 }); setEtaLogged(false); setArrived(false); };

  const triggerBeep = () => {
    try {
      if (!audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioContextRef.current;
      if (ctx.state === 'suspended') ctx.resume();
      const osc = ctx.createOscillator(), g = ctx.createGain();
      osc.connect(g); g.connect(ctx.destination);
      osc.frequency.value = 800; osc.type = 'sine';
      g.gain.setValueAtTime(0.5, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
    } catch (e) { console.error('Beep failed:', e); }
  };

  const corridorColor  = { STABLE: "blue", CRITICAL: "orange", "VERY CRITICAL": "red" }[criticality];
  const corridorPoints = [currentPosition, ...route.slice(segmentIndex + 1)];
  const donorLabel     = donorMode && donorFrom && donorTo ? `ğŸ«€ ${HOSPITAL_NAMES[donorFrom]} â†’ ${HOSPITAL_NAMES[donorTo]}` : null;

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return (
    <div style={{ position: "relative" }}>

      <div style={{
        position: 'absolute', top: 40, left: 50, zIndex: 1000,
        background: "white", padding: "10px", borderRadius: "8px",
        display: "flex", flexDirection: "column", gap: "5px",
        boxShadow: "0 3px 12px rgba(0,0,0,0.25)",
        maxHeight: "92vh", overflowY: "auto", minWidth: "220px",
      }}>

        {/* Mode badge */}
        <div style={{ background: donorMode ? "#7b1fa2" : isMaster ? "#4caf50" : "#ff9800", color: "white", padding: "8px", borderRadius: "4px", fontWeight: "bold", textAlign: "center", fontSize: "12px" }}>
          {donorMode ? donorLabel : isMaster ? "ğŸš‘ MASTER (Ambulance)" : "ğŸ“± FOLLOWER (Traffic Light)"}
        </div>

        <button style={{ background: isMaster ? "#666" : "#4caf50", color: "white", fontWeight: "bold" }} onClick={() => setIsMaster(!isMaster)}>
          {isMaster ? "Switch to Follower" : "Switch to Master"}
        </button>

        <button style={{ background: "#d32f2f", color: "white", fontWeight: "bold" }}
          onClick={async () => {
            try {
              if (!audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
              if (audioContextRef.current.state === 'suspended') await audioContextRef.current.resume();
              triggerBeep();
              alert("Driver alerts enabled! State: " + audioContextRef.current.state);
            } catch { alert("Audio failed"); }
          }}>
          ENABLE DRIVER ALERTS
        </button>

        {isMaster && (<>
          {/* Criticality â€” locked in donor mode */}
          <div style={{ display: "flex", gap: "3px", marginTop: "2px" }}>
            {["STABLE","CRITICAL","VERY CRITICAL"].map(c => (
              <button key={c} disabled={donorMode && c !== "VERY CRITICAL"} onClick={() => setCriticality(c)}
                style={{ flex: 1, fontSize: "10px", padding: "4px 2px",
                  background: criticality === c ? "#1976d2" : "#eee",
                  color: criticality === c ? "white" : donorMode && c !== "VERY CRITICAL" ? "#bbb" : "#333",
                  border: "1px solid #ccc", borderRadius: "3px",
                  cursor: donorMode && c !== "VERY CRITICAL" ? "not-allowed" : "pointer" }}>
                {c}
              </button>
            ))}
          </div>

          {/* Live ETA */}
          <div style={{ fontWeight: "bold", borderTop: "1px solid #ddd", paddingTop: "6px", marginTop: "4px" }}>
            {arrived ? <span style={{ color: "#2e7d32" }}>âœ… {donorMode ? "Organ" : "Ambulance"} Arrived!</span> : <>ETA: {formETA(ETAseconds())}</>}
          </div>

          {/* Route info */}
          {hospitalETAs.length > 0 && (
            <div style={{ fontSize: "12px" }}>
              <b>{donorMode ? "Donor route:" : "Hospital comparison:"}</b>
              {hospitalETAs.map(h => (
                <div key={h.id} style={{ marginTop: "4px", padding: "5px 7px", borderRadius: "5px", background: donorMode ? "#f3e5f5" : selectedHospital?.id === h.id ? "#e8f5e9" : "#f9f9f9", border: `1px solid ${donorMode ? "#7b1fa2" : "#4caf50"}` }}>
                  <div style={{ fontWeight: "bold", fontSize: "11px", color: donorMode ? "#4a148c" : "#1b5e20" }}>{donorMode ? "ğŸ«€ " : "âœ… "}{h.name}</div>
                  <div style={{ fontSize: "11px", color: "#444" }}>{formETA(h.eta)}</div>
                  {h.penalty > 0 && <div style={{ fontSize: "10px", color: "#b71c1c", marginTop: "1px" }}>ğŸ•³ï¸ +{h.penalty}s pothole penalty</div>}
                </div>
              ))}
            </div>
          )}

          {/* Accident-only controls */}
          {!donorMode && (<>
            <button style={{ background: "#1976d2", color: "white", fontWeight: "bold" }} onClick={autoSelectNearestHospital}>ğŸ¥ AUTO SELECT NEAREST</button>
            <button style={{ background: "#555", color: "white" }} onClick={resetLearning}>RESET LEARNING</button>
            <div style={{ marginTop: "6px", border: "2px solid #e65100", borderRadius: "6px", padding: "8px", background: "#fff3e0" }}>
              <div style={{ fontSize: "11px", fontWeight: "bold", color: "#bf360c", marginBottom: "4px" }}>ğŸ§ª DEMO: POTHOLE REROUTING</div>
              <div style={{ fontSize: "10px", color: "#5d4037", marginBottom: "6px", lineHeight: "1.5" }}>
                <b>Step 1:</b> AUTO SELECT â†’ note hospital<br />
                <b>Step 2:</b> INJECT â†’ black ğŸ•³ï¸ appear on map<br />
                <b>Step 3:</b> AUTO SELECT â†’ route changes!<br />
                <b>Step 4:</b> CLEAR â†’ AUTO SELECT â†’ reverts
              </div>
              <button onClick={() => { setUseDummyPotholes(p => !p); setHospitalETAs([]); }}
                style={{ width: "100%", padding: "8px 4px", borderRadius: "5px", border: "none", fontWeight: "bold", fontSize: "12px", cursor: "pointer", background: useDummyPotholes ? "#212121" : "#e65100", color: "white", boxShadow: "0 2px 4px rgba(0,0,0,0.3)" }}>
                {useDummyPotholes ? "ğŸŸ¢ CLEAR POTHOLES" : "ğŸ•³ï¸ INJECT DUMMY POTHOLES"}
              </button>
              {useDummyPotholes && (
                <div style={{ marginTop: "6px", fontSize: "10px", lineHeight: "1.6", background: "#fbe9e7", padding: "5px", borderRadius: "4px" }}>
                  <b>Active (4 potholes):</b><br />
                  <span style={{ color: "#b71c1c" }}>Lisie</span>: 1Ã— severe + 1 moderate<br />
                  <span style={{ color: "#e65100" }}>Aster</span>: 1Ã— severe + 1 moderate<br />
                  <b>â†’ Press AUTO SELECT now</b>
                </div>
              )}
            </div>
          </>)}
        </>)}

        <div style={{ fontSize: "10px", color: "#888", padding: "3px", background: "#f5f5f5", borderRadius: "3px" }}>Device: {deviceId.substr(0, 8)}</div>

        {snappedPotholes.length > 0 && (
          <div style={{ borderTop: "1px solid #ddd", paddingTop: "6px" }}>
            <b style={{ fontSize: "11px" }}>ğŸ•³ï¸ Potholes on map ({snappedPotholes.length})</b>
            {snappedPotholes.map((p, i) => (
              <div key={i} style={{ display: "flex", justifyContent: "space-between", marginTop: "3px", padding: "3px 6px", borderRadius: "3px", background: "#111", color: "white", fontSize: "10px" }}>
                <span><span style={{ display: "inline-block", width: 7, height: 7, borderRadius: "50%", background: getSeverityDotColor(p.severity), marginRight: 5 }} />{p.severity}</span>
                <span style={{ opacity: 0.7 }}>{(p.confidence * 100).toFixed(0)}% conf</span>
              </div>
            ))}
          </div>
        )}
      </div>

      <MapContainer center={center} zoom={15} style={{ height: "100vh", width: "100vw" }}>
        <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" attribution="Â© OpenStreetMap" />

        {corridorColor && route.length > 0 && (
          <Polyline positions={corridorPoints} pathOptions={{ color: donorMode ? "#7b1fa2" : corridorColor, weight: 6, opacity: 1 }} />
        )}

        <Marker position={currentPosition} icon={ambulanceEmoji}>
          <Popup><b>{donorMode ? "ğŸ«€ Donor Transport" : "ğŸš‘ Ambulance"}</b><br />Criticality: {criticality}{donorMode && <><br /><em>Organ transport â€“ highest priority</em></>}</Popup>
        </Marker>

        {signals.map(s => (
          <Marker key={s.id} position={s.position} icon={signalEmoji(s.state)}>
            <Popup><b>Traffic Signal</b><br />State: {s.state}</Popup>
          </Marker>
        ))}

        {cars.map(c => (
          <Marker key={c.id} position={c.position} icon={carIcon}><Popup>Normal Vehicle</Popup></Marker>
        ))}

        {snappedPotholes.map((p, idx) => (
          <CircleMarker key={`pothole-${idx}`} center={[parseFloat(p.lat), parseFloat(p.lng)]} radius={10}
            pathOptions={{ color: POTHOLE_BORDER, fill: true, fillColor: POTHOLE_FILL, fillOpacity: 0.9, weight: 2 }}>
            <Popup>
              <b>ğŸ•³ï¸ Pothole</b><br />
              Severity: <strong style={{ color: getSeverityDotColor(p.severity) }}>{p.severity}</strong><br />
              Confidence: {(p.confidence * 100).toFixed(1)}%
              {useDummyPotholes && <><br /><em style={{ fontSize: "10px" }}>Demo / simulated</em></>}
            </Popup>
          </CircleMarker>
        ))}
      </MapContainer>
    </div>
  );
}

export default MapView;